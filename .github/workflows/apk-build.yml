name: Build APK

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # Expo access token must be defined as a repository secret called EXPO_TOKEN
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    steps:
      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install the requested Node.js version and enable npm caching
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Install project dependencies using npm
      - name: Install dependencies
        run: npm ci

      - name: Set build version
        run: echo "BUILD_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Apply version from tag
        run: |
          node -e "const fs=require('fs'); const path='app.json'; const data=JSON.parse(fs.readFileSync(path,'utf8')); data.expo.version=process.env.BUILD_VERSION; fs.writeFileSync(path, JSON.stringify(data, null, 2) + '\n');"

      # Trigger an EAS build for Android in nonâ€‘interactive mode.
      # The --json flag produces structured output which we save in build.json.
      # A short Node.js script extracts the build identifier and appends it to
      # $GITHUB_ENV so that it can be referenced in later steps if needed.
      - name: Trigger EAS build
        run: |
          npx eas build --platform android --profile preview --non-interactive --json > build.json
          node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('build.json', 'utf8')); const build = Array.isArray(data) ? data[0] : data; console.log(`BUILD_ID=${build.id || build.buildId}`);" >> $GITHUB_ENV

      # Install jq for JSON parsing; apt-get update is required for package lists.
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Download the generated APK. Parse the build URL from build.json using jq
      # and fetch the artifact with curl. The output file will be named iishnitsa.apk.
      - name: Download APK
        run: |
          BUILD_URL=$(jq -r 'if type == "object" then .artifacts.buildUrl else .[0].artifacts.buildUrl end' build.json)
          echo "Build URL: $BUILD_URL"
          curl -L "$BUILD_URL" -o "iishnitsa-${BUILD_VERSION}.apk"

      # Publish the APK as a GitHub release. The release-action will create or
      # update the tag `apk-latest` and attach the APK file. Use allowUpdates to
      # overwrite previous artifacts and makeLatest to mark this release as the latest.
      - name: Publish release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: APK ${{ github.ref_name }}
          artifacts: iishnitsa-${{ env.BUILD_VERSION }}.apk
          artifactContentType: application/vnd.android.package-archive
          allowUpdates: false
          replacesArtifacts: false
          makeLatest: true
