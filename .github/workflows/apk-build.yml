name: Build APK

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: apk-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install the requested Node.js version and enable npm caching
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Install project dependencies using npm
      - name: Install dependencies
        run: npm ci

      - name: Set build version
        run: echo "BUILD_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Apply version from tag
        run: |
          node -e "const fs=require('fs'); const path='app.json'; const data=JSON.parse(fs.readFileSync(path,'utf8')); data.expo.version=process.env.BUILD_VERSION; fs.writeFileSync(path, JSON.stringify(data, null, 2) + '\n');"

      # Generate native Android project and build APK locally on the runner.
      - name: Prebuild Android project
        run: npx expo prebuild --platform android --non-interactive --clean

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease
          cd ..
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -s "$APK_PATH" ]; then
            echo "Release APK not found at $APK_PATH"
            exit 1
          fi
          cp "$APK_PATH" "iishnitsa-${BUILD_VERSION}.apk"

      - name: Generate release notes
        run: |
          git fetch --tags --force
          npx -y -p conventional-changelog-cli -p conventional-changelog-angular conventional-changelog -p angular -r 1 > release-notes.md

      # Publish the APK as a GitHub release. The release-action will create or
      # update the tag `apk-latest` and attach the APK file. Use allowUpdates to
      # overwrite previous artifacts and makeLatest to mark this release as the latest.
      - name: Publish release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: APK ${{ github.ref_name }}
          artifacts: iishnitsa-${{ env.BUILD_VERSION }}.apk
          artifactContentType: application/vnd.android.package-archive
          bodyFile: release-notes.md
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: true
          draft: true

      - name: Publish draft release
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: context.ref.replace("refs/tags/", ""),
            });
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              draft: false,
              make_latest: true,
            });
