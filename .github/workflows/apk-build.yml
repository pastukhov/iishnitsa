name: Build APK

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: apk-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Checkout the repository code
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install the requested Node.js version and enable npm caching
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Install project dependencies using npm
      - name: Install dependencies
        run: npm ci

      - name: Set build version
        run: echo "BUILD_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Apply version from tag
        run: |
          node -e "const fs=require('fs'); const appPath='app.json'; const appData=JSON.parse(fs.readFileSync(appPath,'utf8')); appData.expo.version=process.env.BUILD_VERSION; fs.writeFileSync(appPath, JSON.stringify(appData, null, 2) + '\\n'); const pkgPath='package.json'; const pkgData=JSON.parse(fs.readFileSync(pkgPath,'utf8')); pkgData.version=process.env.BUILD_VERSION; fs.writeFileSync(pkgPath, JSON.stringify(pkgData, null, 2) + '\\n');"

      - name: Generate release notes
        run: |
          git fetch --tags --force
          CURRENT_TAG="${GITHUB_REF_NAME}"
          PREV_TAG=$(git tag -l "v*" --sort=-v:refname | grep -v "^${CURRENT_TAG}$" | head -n 1 || true)
          {
            echo "# ${CURRENT_TAG}"
            echo
            if [ -n "$PREV_TAG" ]; then
              echo "Changes since ${PREV_TAG}:"
              echo
              git log --pretty=format:"- %s (%h)" "${PREV_TAG}..${CURRENT_TAG}"
            else
              echo "Changes:"
              echo
              git log --pretty=format:"- %s (%h)" -n 20
            fi
            echo
          } > release-notes.md
          node -e 'const fs=require("fs"); const notes=fs.readFileSync("release-notes.md","utf8"); const tag=process.env.GITHUB_REF_NAME || "dev"; const content="export const releaseTag = " + JSON.stringify(tag) + ";\n" + "export const releaseNotes = " + JSON.stringify(notes) + ";\n"; fs.writeFileSync("client/constants/releaseNotes.ts", content);'

      # Generate native Android project and build APK locally on the runner.
      - name: Prebuild Android project
        run: npx expo prebuild --platform android --non-interactive --clean

      - name: Configure Gradle Maven mirror
        run: |
          mkdir -p ~/.gradle
          cat > ~/.gradle/init.gradle <<'EOF'
          allprojects {
            repositories {
              maven { url "https://maven-central.storage-download.googleapis.com/maven2" }
              mavenCentral()
              google()
            }
          }
          EOF

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease
          cd ..
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -s "$APK_PATH" ]; then
            echo "Release APK not found at $APK_PATH"
            exit 1
          fi
          cp "$APK_PATH" "iishnitsa-${BUILD_VERSION}.apk"

      - name: Create or update draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          NAME="APK ${GITHUB_REF_NAME}"
          NOTES_FILE="release-notes.md"
          APK="iishnitsa-${BUILD_VERSION}.apk"
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            gh release upload "$TAG" "$APK" --clobber --repo "$GITHUB_REPOSITORY"
            gh release edit "$TAG" --title "$NAME" --notes-file "$NOTES_FILE" --draft --repo "$GITHUB_REPOSITORY"
          else
            gh release create "$TAG" "$APK" --title "$NAME" --notes-file "$NOTES_FILE" --draft --repo "$GITHUB_REPOSITORY"
          fi

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
        if: ${{ !contains(github.ref_name, '-') }}
        run: |
          gh release edit "$GITHUB_REF_NAME" --draft=false --latest --repo "$GITHUB_REPOSITORY"
